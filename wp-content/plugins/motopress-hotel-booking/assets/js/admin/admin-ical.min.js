!function(a,r){"use strict";a(function(){function i(t,o,e,s){return s=void 0!==s?s:{},(e=void 0!==e?e:{}).action=t,e.mphb_nonce=r.nonces.hasOwnProperty(t)?r.nonces[t]:"",s=a.extend(s,{url:r.ajaxUrl,dataType:"json",data:e,success:function(t,e,s){var i=!0===t.success,n=t.data||{};o(i,n)}}),a.ajax(s)}r.ControlButton=can.Control.extend({},{inSuspended:!1,wasDisabled:!1,defaultText:"",actionText:"",ajaxAction:"",importer:null,init:function(t,e){this.defaultText=e.defaultText,this.actionText=e.actionText,this.ajaxAction=e.ajaxAction,this.importer=e.importer},click:function(t,e){if(this.inSuspended)return!1;this.doAction()},doAction:function(){},activate:function(){this.inSuspended=!0,this.element.prop("disabled",!0),this.element.text(this.actionText)},enable:function(){this.isSuspended=!1,this.element.prop("disabled",!1),this.element.text(this.defaultText)},disable:function(){this.isSuspended=!1,this.element.prop("disabled",!0),this.element.text(this.defaultText)},suspend:function(){this.inSuspended=!0,this.wasDisabled=!!this.element.prop("disabled"),this.element.prop("disabled",!0)},restore:function(){this.isSuspended=!1,this.element.prop("disabled",this.wasDisabled)}}),r.AbortButton=r.ControlButton.extend({},{doAction:function(){this.activate(),this.importer.stop();var s=this;i(s.ajaxAction,function(t,e){s.importer.start(),t||s.enable()},{},{method:"POST"})}}),r.ClearAllButton=r.ControlButton.extend({},{doAction:function(){this.activate(),this.importer.stop(),this.importer.trigger("mphb:clear_all:before");var s=this;i(this.ajaxAction,function(t,e){t?(s.importer.trigger("mphb:clear_all"),s.disable()):(s.importer.trigger("mphb:clear_all:failed"),s.enable()),s.importer.start()},{},{method:"POST"})}}),r.DetailsTableRoom=can.Control.extend({},{key:"",status:"",statusEl:null,totalEl:null,succeedEl:null,failedEl:null,skippedEl:null,removedEl:null,oldStatusClass:"",emptyValuePlaceholder:"&#8212;",init:function(t,e){this.key=t.attr("data-item-key"),this.status=t.attr("data-sync-status"),this.statusEl=t.find(".column-status > span"),this.totalEl=t.find(".column-total"),this.succeedEl=t.find(".column-succeed"),this.failedEl=t.find(".column-failed"),this.skippedEl=t.find(".column-skipped"),this.removedEl=t.find(".column-removed"),this.oldStatusClass=this.statusEl.attr("class")},changeContent:function(t){this.status=t.status.code,this.element.attr("data-sync-status",this.status),this.statusEl.removeClass(this.oldStatusClass),this.statusEl.addClass(t.status.class),this.oldStatusClass=t.status.class,this.statusEl.text(t.status.text),0!=t.stats.total?this.totalEl.text(t.stats.total):this.totalEl.html(this.emptyValuePlaceholder),0!=t.stats.succeed?this.succeedEl.text(t.stats.succeed):this.succeedEl.html(this.emptyValuePlaceholder),0!=t.stats.failed?this.failedEl.text(t.stats.failed):this.failedEl.html(this.emptyValuePlaceholder),0!=t.stats.skipped?this.skippedEl.text(t.stats.skipped):this.skippedEl.html(this.emptyValuePlaceholder),0!=t.stats.removed?this.removedEl.text(t.stats.removed):this.removedEl.html(this.emptyValuePlaceholder),0<t.stats.failed&&this.element.addClass("mphb-have-errors")},clear:function(){this.element.remove()},getKey:function(){return this.key},getStatus:function(){return this.status}}),r.DetailsTable=can.Control.extend({},{itemsSingularText:"%d item",itemsPluralText:"%d items",ajaxAction:"",importer:null,rooms:{},roomsCount:0,roomsCountEl:null,init:function(t,e){this.itemsSingularText=e.itemsSingularText,this.itemsPluralText=e.itemsPluralText,this.ajaxAction=e.ajaxAction,this.importer=e.importer,this.initRooms(),this.initRemoveButtons(),this.roomsCountEl=t.parent().find(".displaying-num")},initRooms:function(){var t=this.element.find("tbody > tr:not(.mphb-logs-wrapper):not(.no-items)"),n={},o=0;t.each(function(t,e){var s=new r.DetailsTableRoom(a(e)),i=s.getKey();n[i]=s,o++}),this.rooms=n,this.roomsCount=o},initRemoveButtons:function(){var s=this;this.element.find(".mphb-remove-item").addClass("mphb-inited").on("click",function(t){t.preventDefault(),t.stopPropagation();var e=a(this).parents("tr").attr("data-item-key");e&&s.rooms[e]&&(a(this).prop("disabled",!0),s.removeRoomByKey(e))})},removeRoomByKey:function(e){this.importer.stop();var s=this;i(this.ajaxAction,function(t){t?s.removeRoom(s.rooms[e]):s.element.find(".mphb-remove-item:disabled").prop("disabled",!1),s.importer.start()},{mphb_room_key:e},{method:"POST"})},removeRoom:function(t){t.clear(),delete this.rooms[t.getKey()],this.roomsCount--,this.decreaseCountInView(),this.isEmpty()&&location.reload(!0)},clear:function(){var s=this;a.each(this.rooms,function(t,e){s.removeRoom(e)}),this.roomsCount=0},isEmpty:function(){return 0==this.roomsCount},changeContent:function(t){var s=this;a.each(t,function(t,e){null!=s.rooms[t]&&s.rooms[t].changeContent(e)})},decreaseCountInView:function(){var t=this.roomsCountEl.text().match(/\d+/);if(null!=t){var e=parseInt(t[0]),s=(1==--e?this.itemsSingularText:this.itemsPluralText).replace("%d",e);this.roomsCountEl.text(s)}},getKeysOfUndone:function(){var s=[];return a.each(this.rooms,function(t,e){"done"!=e.getStatus()&&s.push(t)}),s}}),r.ImportStats=can.Control.extend({},{totalEl:null,succeedEl:null,skippedEl:null,failedEl:null,removedEl:null,init:function(t,e){this.totalEl=this.element.find(".mphb-total"),this.succeedEl=this.element.find(".mphb-succeed"),this.skippedEl=this.element.find(".mphb-skipped"),this.failedEl=this.element.find(".mphb-failed"),this.removedEl=this.element.find(".mphb-removed")},updateStats:function(t){this.totalEl.text(t.total),this.succeedEl.text(t.succeed),this.skippedEl.text(t.skipped),this.failedEl.text(t.failed),this.removedEl.text(t.removed)}}),r.Importer=can.Control.extend({},{tickInterval:2e3,shortTickInterval:500,retriesCount:1,retriesLeft:0,inProgress:!1,updateTimeout:null,preventUpdates:!1,init:function(t,e){this.inProgress=e.inProgress,this.resetRetries(),this.inProgress&&this.start()},start:function(){this.preventUpdates=!1,this.updateTimeout=setTimeout(this.tick.bind(this),this.shortTickInterval)},requestUpdate:function(){this.preventUpdates=!1,this.updateTimeout=setTimeout(this.tick.bind(this),this.tickInterval)},stop:function(){clearTimeout(this.updateTimeout),this.preventUpdates=!0},resetRetries:function(){this.retriesLeft=this.retriesCount},markInProgress:function(){this.inProgress=!0},markStopped:function(){this.inProgress=!1},trigger:function(t){this.element.trigger(t)}}),r.LogsHandler=can.Control.extend({},{shown:0,insertLogs:function(t){this.element.append(t)},setShown:function(t){this.shown=t}}),r.ProgressBar=can.Control.extend({},{barEl:null,textEl:null,init:function(t,e){this.barEl=this.element.find(".mphb-progress__bar"),this.textEl=this.element.find(".mphb-progress__text")},updateProgress:function(t){this.barEl.css("width",t+"%"),this.textEl.text(t+"%")}}),r.SyncImporter=r.Importer.extend({},{abortButton:null,clearAllButton:null,detailsTable:null,init:function(t,e){this._super(t,e),this.detailsTable=new r.DetailsTable(this.element.find(".mphb-ical-sync-table"),{itemsSingularText:r.i18n.items_singular,itemsPluralText:r.i18n.items_plural,ajaxAction:r.actions.sync.remove_item,importer:this}),this.abortButton=new r.AbortButton(this.element.find(".mphb-abort-process"),{defaultText:r.i18n.abort,actionText:r.i18n.aborting,ajaxAction:r.actions.sync.abort,importer:this}),this.clearAllButton=new r.ClearAllButton(this.element.find(".mphb-clear-all"),{defaultText:r.i18n.clear,actionText:r.i18n.clearing,ajaxAction:r.actions.sync.clear_all,importer:this})},tick:function(){var s=this,t=this.detailsTable.getKeysOfUndone();i(r.actions.sync.progress,function(t,e){s.preventUpdates||(t?(s.resetRetries(),e.inProgress?s.markInProgress():s.markStopped(),s.detailsTable.changeContent(e.items),s.inProgress?s.requestUpdate():s.abortButton.disable()):0<s.retriesLeft?(s.retriesLeft--,s.requestUpdate()):s.abortButton.disable())},{focus:t},{method:"POST"})},"mphb:clear_all":function(){this.abortButton.disable(),this.clearAllButton.disable(),this.detailsTable.clear()},"mphb:clear_all:before":function(){this.abortButton.suspend()},"mphb:clear_all:failed":function(){this.abortButton.restore()}}),r.UploadImporter=r.Importer.extend({},{progressBar:null,logsHandler:null,importStats:null,init:function(t,e){this._super(t,e),this.progressBar=new r.ProgressBar(this.element.find(".mphb-progress")),this.logsHandler=new r.LogsHandler(this.element.find(".mphb-logs")),this.importStats=new r.ImportStats(this.element.find(".mphb-import-stats")),this.abortButton=new r.AbortButton(this.element.find(".mphb-abort-process"),{defaultText:r.i18n.abort,actionText:r.i18n.aborting,ajaxAction:r.actions.upload.abort,importer:this})},tick:function(){var s=this;i(r.actions.upload.progress,function(t,e){t?(s.resetRetries(),e.isFinished?s.markStopped():s.markInProgress(),s.importStats.updateStats(e),s.progressBar.updateProgress(e.progress),s.logsHandler.setShown(e.logsShown),s.logsHandler.insertLogs(e.logs),a(e.notice).insertAfter(".wp-heading-inline"),s.inProgress?s.requestUpdate():s.abortButton.disable()):0<s.retriesLeft?(s.retriesLeft--,s.requestUpdate()):s.abortButton.disable()},{logsShown:s.logsHandler.shown})}});var t=a(".mphb-sync-details-wrapper");t.length&&new r.SyncImporter(t,{inProgress:r.inProgress});var e=a(".mphb-upload-import-details-wrapper");e.length&&new r.UploadImporter(e,{inProgress:r.inProgress})})}(jQuery,MPHB_iCal);